<!doctype html>
<html lang="ru">
    <head>
      	<meta charset="utf-8">
      	<meta name="viewpoint" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
      	<title>Chord progression tool</title>
    </head>
    <body class="text-center px-1">
        <header class="mb-4 border-bottom">
            <p>Chord progression by type</p>
        </header>
        <div class="justify-content-center d-flex">
            <div style="width: 70vw;">
                <div class="container">
                    <div class="row">
                        <div class="col-4 bg-primary text-white border-end">
                            <div class="row">
                                <div class="col">&nbsp;</div>
                                <div class="col"><p class="text-end">Tuning &rarr;</p></div>
                            </div>
                            <div class="row">
                                <div class="col"><p class="text-end">Chords &darr;</p></div>
                                <div class="col"><p class="text-end">KEY &rarr;</p></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                
                                
                            </div>
                        </div>
                        <div class="col text-start bg-primary text-white">
                            <select class="form-select" id="tuningKey">
                                <option value="0" selected>Standard</option>
                                <option value="1">Drop D</option>
                            </select>
                            <select class="form-select" id="noteKey">
                                <option value="0" selected>C</option>
                                <option value="1">C#</option>
                                <option value="2">D</option>
                                <option value="3">D#</option>
                                <option value="4">E</option>
                                <option value="5">F</option>
                                <option value="6">F#</option>
                                <option value="7">G</option>
                                <option value="8">G#</option>
                                <option value="9">A</option>
                                <option value="10">A#</option>
                                <option value="11">B</option>
                            </select>
                        </div>
                    </div>
                    <div id="main-container"></div>
                </div>
            </div>
        </div>
        
        <script type="text/javascript">
            let notesArray = [
                // [key name] //[array num] - [chromatic scale num]
                'C',          //0           - 1
                'C#',         //1           - 2
                'D',          //2           - 3
                'D#',         //3           - 4
                'E',          //4           - 5
                'F',          //5           - 6
                'F#',         //6           - 7
                'G',          //7           - 8
                'G#',         //8           - 9
                'A',          //9           - 10
                'A#',         //10          - 11
                'B'           //11          - 12
            ];
            let tuning = [
                {
                    name: 'standard',
                    tune: [4,11,7,2,9,4]//reversed
                    // tune: [4,9,2,7,11,4]
                },
                {
                    name: 'drop D',
                    tune: [4,11,7,2,9,2]//reversed
                    // tune: [2,9,2,7,11,4]
                }
            ]
            // major minor sus2 sus4 maj7 ma7 min7 dim7 add9 add13 maj6 maj9 nona9 udenc11 terzdec13 
            let progressions = [
                {
                    type : 'major',
                    name: 'Major',
                    color: 'bg-secondary',
                    progression : [0,4,7]
                },
                {
                    type : 'minor',
                    name: 'Minor',
                    color: 'bg-secondary',
                    progression : [0,3,7]
                },
                {
                    type : 'sus2',
                    name: 'sus2',
                    color: 'bg-warning',
                    progression : [0,2,7]
                },
                {
                    type : 'sus4',
                    name: 'sus4',
                    color: 'bg-warning',
                    progression : [0,4,7]
                },
                {
                    type : 'maj7',
                    name: 'Major 7',
                    color: 'bg-success',
                    progression : [0,4,7,11]
                },
                {
                    type : 'ma7',
                    name: '7',
                    color: 'bg-success',
                    progression : [0,4,7,10]
                },
                {
                    type : 'min7',
                    name: 'Minor 7',
                    color: 'bg-success',
                    progression : [0,3,7,10]
                },
                {
                    type : 'dim7',
                    name: 'Dim 7',
                    color: 'bg-success',
                    progression : [0,3,6,9]
                },
                {
                    type : 'add9',
                    name: 'add9',
                    color: 'bg-info',
                    progression : [0,4,7,2]
                },
                {
                    type : 'add13',
                    name: 'add13',
                    color: 'bg-info',
                    progression : [0,4,7,9]
                },
                {
                    type : 'maj6',
                    name: '6 (major)',
                    color: 'bg-dark',
                    progression : [0,4,7,9]
                },
                {
                    type : 'maj9',
                    name: '9 (major)',
                    color: 'bg-dark',
                    progression : [0,4,7,2]
                },
                {
                    type : 'nona9',
                    name: '9 (nonaccord)',
                    color: 'bg-danger',
                    progression : [0,4,7,8,2]
                },
                {
                    type : 'udenc11',
                    name: '11 (udencimaccord)',
                    color: 'bg-danger',
                    progression : [0,4,7,8,2,5]
                },
                {
                    type : 'terzdec13',
                    name: '13 (terzdecimaccord)',
                    color: 'bg-danger',
                    progression : [0,4,7,8,2,5,9]
                },
            ];
            
            //get ket from query string
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            // console.log(urlParams.get('key'));
            let keyNode = document.getElementById('noteKey');
            let tuningNode = document.getElementById('tuningKey');
            let key = (queryString === '') ? document.getElementById('noteKey').value : ((urlParams.get('key') !== null && notesArray.indexOf(urlParams.get('key').toLocaleUpperCase()) !== -1) ? notesArray.indexOf(urlParams.get('key').toLocaleUpperCase()) : document.getElementById('noteKey').value);
            // console.log('key = ', key);
            
            function makeChords(keyNum, tuningKey) {
                //re-make arrays
                if(tuningKey == undefined) tuningKey = tuningNode.value;
                let newNoteArr = notesArray;
                if(keyNum > 0) {
                    let secondPart = notesArray.slice(0, keyNum);
                    let firstPart = notesArray.slice(keyNum, notesArray.length+1);
                    newNoteArr = [...firstPart, ...secondPart];
                }
                let mainContainer = document.getElementById('main-container');
                let chordContainer;
                let iter = 0;
                let stringsContainer;
                let stringsTarget;
                let firstRow;
                let secondRow;
                let colName;
                let colProg;
                let divProg;
                let pName;
                let divFret;
                let colFret;
                let containerProgression;
                let stringRow;
                let fretCol;
                let tuningArray = tuning[tuningKey]['tune'];//TODO: make a selection of tuning
                let tuningPoint;
                mainContainer.innerHTML = '';
                progressions.forEach(element => {
                    //creating progression row
                    firstRow = document.createElement('div');
                    firstRow.classList.add('row');
                    colName = document.createElement('div');
                    colName.classList.add('col-4',element["color"],'border-end','text-white');
                    pName = document.createElement('p');
                    pName.textContent = element["name"];
                    colProg = document.createElement('div');
                    colProg.classList.add('col',element["color"],'text-white');
                    divProg = document.createElement('div');
                    divProg.classList.add('d-flex');
                    divProg.id = element["type"];
                    colName.append(pName);
                    colProg.append(divProg);
                    firstRow.append(colName, colProg);
                    //creating fret row
                    secondRow = document.createElement('div');
                    secondRow.classList.add('row');
                    colFret = document.createElement('div');
                    colFret.classList.add('col');
                    containerProgression = document.createElement('div');
                    containerProgression.classList.add('container-' + element["type"]);
                    //strings
                    for(i=0; i<tuningArray.length; i++) {
                        stringRow = document.createElement('div');
                        stringRow.classList.add('row');
                        //frets
                        for(j=0; j<12; j++) {
                            tuningPoint = (((parseInt(tuningArray[i]) + j) > 11 ? ((parseInt(tuningArray[i]) + j) - 12) : (parseInt(tuningArray[i]) + j)));
                            fretCol = document.createElement('div');
                            if(j==0) {
                                fretCol.classList.add('col','border-end', 'border-bottom', 'step'+tuningPoint, 'border-start', 'fw-bold');
                            } else {
                                fretCol.classList.add('col','border-end', 'border-bottom', 'step'+tuningPoint);
                            }
                            fretCol.textContent = notesArray[tuningPoint];
                            stringRow.append(fretCol);
                        }
                        containerProgression.append(stringRow);
                    }
                    stringRow = document.createElement('div');
                    stringRow.classList.add('row');
                    //fret numbers
                    for(j=0; j<12; j++) {
                        fretCol = document.createElement('div');
                        if(j==0) {
                            fretCol.classList.add('col','border-end', 'border-bottom', 'border-start', 'fw-bold');
                        } else {
                            fretCol.classList.add('col','border-end', 'border-bottom');
                        }
                        fretCol.textContent = j;
                        stringRow.append(fretCol);
                    }
                    containerProgression.append(stringRow);
                    colFret.append(containerProgression);
                    secondRow.append(colFret);
                    //adding to main progression container
                    mainContainer.append(firstRow);
                    mainContainer.append(secondRow);
                    // console.log(element["type"], element["progression"]);
                    
                    iter = 0;
                    chordContainer = divProg;//document.getElementById(element["type"]);
                    // stringsContainer = document.getElementsByClassName('container-' + element["type"]);
                    stringsContainer = document.querySelector('.container-' + element["type"]);
                    if(stringsContainer) {
                        stringsTarget = stringsContainer.querySelectorAll('div.col');
                        stringsTarget.forEach(stringElement => {
                            stringElement.style.backgroundColor = 'transparent';
                        });
                    }
                    // console.log(stringsContainer);
                    let currStep;
                    element["progression"].forEach(progs => {
                        //console.log('keynum = ',keyNum,'prog = ',progs);
                        currStep = ((parseInt(keyNum) + parseInt(progs)) > 11) ? ((parseInt(keyNum) + parseInt(progs))-12) : parseInt(keyNum) + parseInt(progs);
                        //console.log(currStep);
                        chordContainer.innerHTML = ((iter == 0) ? "" : chordContainer.innerHTML) + "<p style='margin-right: 2.5em;'><b>" + newNoteArr[progs] + "</b></p>" ;
                        if(stringsContainer) {
                            stringsTarget = stringsContainer.querySelectorAll('div.step'+currStep);
                            // console.log(stringsTarget);
                            stringsTarget.forEach(stringElement => {
                                // console.log('curr string - ',stringElement);
                                stringElement.style.backgroundColor = 'green';
                            });
                        }
                        iter++; 
                    });
                    stringsTarget = null;
                    stringsContainer = null;
                });
            }
            window.addEventListener("load", function() {
                if (queryString !== '' && ((urlParams.get('key') !== null && notesArray.indexOf(urlParams.get('key').toLocaleUpperCase()) !== -1))) {
                    keyNode.value = key;
                }
                makeChords(key);
                console.log("key = ", key);
            });
            keyNode.addEventListener('change', function() {
                // console.log("key changed = ", this.value);
                makeChords(this.value);
            });
            tuningNode.addEventListener('change', function() {
                // console.log("key changed = ", this.value);
                makeChords(keyNode.value, this.value);
            });
        </script>
    </body>
</html>